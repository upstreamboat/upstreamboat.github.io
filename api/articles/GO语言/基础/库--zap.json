{"title":"库--zap","uid":"41abb34d9ed07e2f1a572226070d62d0","slug":"GO语言/基础/库--zap","date":"2024-10-12T02:26:58.682Z","updated":"2024-10-19T08:24:15.497Z","comments":true,"path":"api/articles/GO语言/基础/库--zap.json","keywords":null,"cover":"/images/cover/5.png","content":"<h1 id=\"库–zap\"><a href=\"#库–zap\" class=\"headerlink\" title=\"库–zap\"></a>库–zap</h1><p>无需细究内容，需要使用 zap 时直接复制即可</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> initialization</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"string\">&quot;ginchat/global&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"string\">&quot;github.com/natefinch/lumberjack&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"string\">&quot;go.uber.org/zap&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"string\">&quot;go.uber.org/zap/zapcore&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"string\">&quot;os&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"string\">&quot;path/filepath&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"string\">&quot;time&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> (</span><br><span class=\"line\">    level   zapcore.Level <span class=\"comment\">// zap 日志等级</span></span><br><span class=\"line\">    options []zap.Option  <span class=\"comment\">// zap 配置项</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">InitializeLog</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// 1、设置日志等级</span></span><br><span class=\"line\">    setLogLevel()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 设置是否输出文件名和行号</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> global.App.Config.Log.ShowLine &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        options = <span class=\"built_in\">append</span>(options, zap.AddCaller())</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 2、创建编码器</span></span><br><span class=\"line\"></span><br><span class=\"line\">    encoder := setEncoder()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 设置输出位置：这里设置了两个位置，分别是文件和控制台</span></span><br><span class=\"line\"></span><br><span class=\"line\">    writeSyncerToFile := getLogWriter()</span><br><span class=\"line\"></span><br><span class=\"line\">    writeSyncerToStdout := zapcore.AddSync(os.Stdout)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 3、创建zap核心</span></span><br><span class=\"line\"></span><br><span class=\"line\">    core := getZapCore(encoder, writeSyncerToFile, writeSyncerToStdout)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 创建zap</span></span><br><span class=\"line\"></span><br><span class=\"line\">    global.App.ZapLog = zap.New(core, options...).Sugar()</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">setLogLevel</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">switch</span> global.App.Config.Log.Level &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"string\">&quot;debug&quot;</span>:</span><br><span class=\"line\"></span><br><span class=\"line\">        level = zap.DebugLevel</span><br><span class=\"line\"></span><br><span class=\"line\">        options = <span class=\"built_in\">append</span>(options, zap.AddStacktrace(level))</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"string\">&quot;info&quot;</span>:</span><br><span class=\"line\"></span><br><span class=\"line\">        level = zap.InfoLevel</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"string\">&quot;warn&quot;</span>:</span><br><span class=\"line\"></span><br><span class=\"line\">        level = zap.WarnLevel</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"string\">&quot;error&quot;</span>:</span><br><span class=\"line\"></span><br><span class=\"line\">        level = zap.ErrorLevel</span><br><span class=\"line\"></span><br><span class=\"line\">        options = <span class=\"built_in\">append</span>(options, zap.AddStacktrace(level))</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"string\">&quot;dpanic&quot;</span>:</span><br><span class=\"line\"></span><br><span class=\"line\">        level = zap.DPanicLevel</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"string\">&quot;panic&quot;</span>:</span><br><span class=\"line\"></span><br><span class=\"line\">        level = zap.PanicLevel</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"string\">&quot;fatal&quot;</span>:</span><br><span class=\"line\"></span><br><span class=\"line\">        level = zap.FatalLevel</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">default</span>:</span><br><span class=\"line\"></span><br><span class=\"line\">        level = zap.InfoLevel</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">setEncoder</span><span class=\"params\">()</span></span> zapcore.Encoder &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">var</span> encoder zapcore.Encoder</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 创建编码器配置</span></span><br><span class=\"line\"></span><br><span class=\"line\">    encoderConfig := zap.NewProductionEncoderConfig()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 设置时间格式</span></span><br><span class=\"line\"></span><br><span class=\"line\">    encoderConfig.EncodeTime = <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(time time.Time, encoder zapcore.PrimitiveArrayEncoder)</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        encoder.AppendString(time.Format(<span class=\"string\">&quot;[&quot;</span> + <span class=\"string\">&quot;2006-01-02 15:04:05.000&quot;</span> + <span class=\"string\">&quot;]&quot;</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 设置“等级”显示样式：大写+颜色</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//encoderConfig.EncodeLevel = zapcore.LowercaseColorLevelEncoder    // 写入文件的日志颜色会无法显示</span></span><br><span class=\"line\"></span><br><span class=\"line\">    encoderConfig.EncodeLevel = <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(l zapcore.Level, encoder zapcore.PrimitiveArrayEncoder)</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        encoder.AppendString(<span class=\"string\">&quot;local&quot;</span> + <span class=\"string\">&quot;.&quot;</span> + l.String())</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 根据配置创建编码器</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> global.App.Config.Log.Format == <span class=\"string\">&quot;json&quot;</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        encoder = zapcore.NewJSONEncoder(encoderConfig)</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        encoder = zapcore.NewConsoleEncoder(encoderConfig)</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> encoder</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 使用 lumberjack 作为日志写入器</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">getLogWriter</span><span class=\"params\">()</span></span> zapcore.WriteSyncer &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    stSeparator := <span class=\"type\">string</span>(filepath.Separator)</span><br><span class=\"line\"></span><br><span class=\"line\">    stRootDir, _ := os.Getwd()</span><br><span class=\"line\"></span><br><span class=\"line\">    stLogFilePath := stRootDir + stSeparator + <span class=\"string\">&quot;log&quot;</span> + stSeparator + time.Now().Format(<span class=\"string\">&quot;2006-01-02&quot;</span>) + <span class=\"string\">&quot;.log&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    file := &amp;lumberjack.Logger&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        Filename:   stLogFilePath,</span><br><span class=\"line\"></span><br><span class=\"line\">        MaxSize:    global.App.Config.Log.MaxSize,</span><br><span class=\"line\"></span><br><span class=\"line\">        MaxBackups: global.App.Config.Log.MaxBackups,</span><br><span class=\"line\"></span><br><span class=\"line\">        MaxAge:     global.App.Config.Log.MaxAge,</span><br><span class=\"line\"></span><br><span class=\"line\">        Compress:   global.App.Config.Log.Compress,</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> zapcore.AddSync(file)</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 扩展 Zap</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">getZapCore</span><span class=\"params\">(encoder zapcore.Encoder, writeSyncer ...zapcore.WriteSyncer)</span></span> zapcore.Core &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    core := zapcore.NewCore(</span><br><span class=\"line\"></span><br><span class=\"line\">        encoder,</span><br><span class=\"line\"></span><br><span class=\"line\">        zapcore.NewMultiWriteSyncer(writeSyncer...),</span><br><span class=\"line\"></span><br><span class=\"line\">        level,</span><br><span class=\"line\"></span><br><span class=\"line\">    )</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> core</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n","text":"库–zap无需细究内容，需要使用 zap 时直接复制即可 123456789101112131415161718192021222324252627282930...","permalink":"/post/GO语言/基础/库--zap","photos":[],"count_time":{"symbolsCount":"3.7k","symbolsTime":"3 mins."},"categories":[{"name":"GO语言","slug":"GO语言","count":77,"path":"api/categories/GO语言.json"}],"tags":[{"name":"技术","slug":"技术","count":168,"path":"api/tags/技术.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%BA%93%E2%80%93zap\"><span class=\"toc-text\">库–zap</span></a></li></ol>","author":{"name":"upstreamboat","slug":"blog-author","avatar":"images/favicon/favicon.ico","link":"/","description":"nothing to say","socials":{"github":"https://github.com/upstreamboat","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{"bilibili":{"icon":"/images/favicon/bilibili.svg","link":"https://www.bilibili.com/"},"chatgpt":{"icon":"/images/favicon/chatgpt.svg","link":"https://chatgpt.com/"}}}},"mapped":true,"hidden":false,"prev_post":{"title":"库--gjson","uid":"5fe51bea965d1cf766e7673df4ca914f","slug":"GO语言/基础/库--gjson","date":"2024-10-12T02:26:58.690Z","updated":"2024-10-19T08:24:17.509Z","comments":true,"path":"api/articles/GO语言/基础/库--gjson.json","keywords":null,"cover":"/images/cover/5.png","text":"库–gjson直接获取 json 中字段内容，无需序列化github.com/tidwall/gjson ","permalink":"/post/GO语言/基础/库--gjson","photos":[],"count_time":{"symbolsCount":63,"symbolsTime":"1 mins."},"categories":[{"name":"GO语言","slug":"GO语言","count":77,"path":"api/categories/GO语言.json"}],"tags":[{"name":"技术","slug":"技术","count":168,"path":"api/tags/技术.json"}],"author":{"name":"upstreamboat","slug":"blog-author","avatar":"images/favicon/favicon.ico","link":"/","description":"nothing to say","socials":{"github":"https://github.com/upstreamboat","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{"bilibili":{"icon":"/images/favicon/bilibili.svg","link":"https://www.bilibili.com/"},"chatgpt":{"icon":"/images/favicon/chatgpt.svg","link":"https://chatgpt.com/"}}}}},"next_post":{"title":"库--casbin","uid":"d7434239378216dfafb37dc4b2b89c73","slug":"GO语言/基础/库--casbin","date":"2024-10-12T02:26:58.632Z","updated":"2024-10-19T08:24:13.211Z","comments":true,"path":"api/articles/GO语言/基础/库--casbin.json","keywords":null,"cover":"/images/cover/5.png","text":"库–casbin 创建权限配置来源 adapter（db 或者 file） 1adapter, err := gormadapter.NewAdapterByD...","permalink":"/post/GO语言/基础/库--casbin","photos":[],"count_time":{"symbolsCount":800,"symbolsTime":"1 mins."},"categories":[{"name":"GO语言","slug":"GO语言","count":77,"path":"api/categories/GO语言.json"}],"tags":[{"name":"技术","slug":"技术","count":168,"path":"api/tags/技术.json"}],"author":{"name":"upstreamboat","slug":"blog-author","avatar":"images/favicon/favicon.ico","link":"/","description":"nothing to say","socials":{"github":"https://github.com/upstreamboat","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{"bilibili":{"icon":"/images/favicon/bilibili.svg","link":"https://www.bilibili.com/"},"chatgpt":{"icon":"/images/favicon/chatgpt.svg","link":"https://chatgpt.com/"}}}}}}