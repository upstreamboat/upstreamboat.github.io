{"title":"解决并发中的数据竞争","uid":"7d5dd673ed6b043bd52abfc3df092197","slug":"GO语言/运用/解决并发中的数据竞争","date":"2024-10-12T02:28:08.885Z","updated":"2024-10-19T08:25:26.506Z","comments":true,"path":"api/articles/GO语言/运用/解决并发中的数据竞争.json","keywords":null,"cover":"/images/cover/5.png","content":"<h1 id=\"解决并发中的数据竞争\"><a href=\"#解决并发中的数据竞争\" class=\"headerlink\" title=\"解决并发中的数据竞争\"></a>解决并发中的数据竞争</h1><ul>\n<li><p>发生竞争的例子：</p>\n  <figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">Test01</span><span class=\"params\">(t *testing.T)</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    sum := <span class=\"type\">int32</span>(<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    wg := sync.WaitGroup&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; <span class=\"number\">1000</span>; i++ &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        wg.Add(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        sum++ <span class=\"comment\">// 多个协程会争抢sum，导致结果不如预期</span></span><br><span class=\"line\"></span><br><span class=\"line\">            wg.Done()</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;()</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    wg.Wait()</span><br><span class=\"line\"></span><br><span class=\"line\">    t.Log(sum)</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 预期结果1000</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 实际结果996</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>避免竞争</p>\n</li>\n</ul>\n<ol>\n<li><p>法一：设置为单核 CPU</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">runtime.GOMAXPROCS(<span class=\"number\">1</span>)</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>法二：使用 atomic 原子操作</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">atomic.AddInt32(&amp;sum, <span class=\"number\">1</span>)</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>法三：加互斥锁</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lock := sync.Mutex&#123;&#125;</span><br></pre></td></tr></table></figure></li>\n</ol>\n","text":"解决并发中的数据竞争 发生竞争的例子： 1234567891011121314151617181920212223242526272829func Test01...","permalink":"/post/GO语言/运用/解决并发中的数据竞争","photos":[],"count_time":{"symbolsCount":512,"symbolsTime":"1 mins."},"categories":[{"name":"GO语言","slug":"GO语言","count":77,"path":"api/categories/GO语言.json"}],"tags":[{"name":"技术","slug":"技术","count":168,"path":"api/tags/技术.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E8%A7%A3%E5%86%B3%E5%B9%B6%E5%8F%91%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E7%AB%9E%E4%BA%89\"><span class=\"toc-text\">解决并发中的数据竞争</span></a></li></ol>","author":{"name":"upstreamboat","slug":"blog-author","avatar":"images/favicon/favicon.ico","link":"/","description":"nothing to say","socials":{"github":"https://github.com/upstreamboat","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{"bilibili":{"icon":"/images/favicon/bilibili.svg","link":"https://www.bilibili.com/"},"chatgpt":{"icon":"/images/favicon/chatgpt.svg","link":"https://chatgpt.com/"}}}},"mapped":true,"hidden":false,"prev_post":{"title":"关于文件读取的坑","uid":"61905ffd46add556f1be34610df1a4c5","slug":"GO语言/运用/关于文件读取的坑","date":"2024-10-12T02:28:08.922Z","updated":"2024-10-19T08:25:28.520Z","comments":true,"path":"api/articles/GO语言/运用/关于文件读取的坑.json","keywords":null,"cover":"/images/cover/5.png","text":"关于文件读取的坑打开文件123456789file, err := os.OpenFile(\"./input.txt\", os.O_CREATE|os.O_RD...","permalink":"/post/GO语言/运用/关于文件读取的坑","photos":[],"count_time":{"symbolsCount":"2.4k","symbolsTime":"2 mins."},"categories":[{"name":"GO语言","slug":"GO语言","count":77,"path":"api/categories/GO语言.json"}],"tags":[{"name":"技术","slug":"技术","count":168,"path":"api/tags/技术.json"}],"author":{"name":"upstreamboat","slug":"blog-author","avatar":"images/favicon/favicon.ico","link":"/","description":"nothing to say","socials":{"github":"https://github.com/upstreamboat","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{"bilibili":{"icon":"/images/favicon/bilibili.svg","link":"https://www.bilibili.com/"},"chatgpt":{"icon":"/images/favicon/chatgpt.svg","link":"https://chatgpt.com/"}}}}},"next_post":{"title":"关于gorm参数问题","uid":"ffad629c88d3973ffcc37250426c5ddb","slug":"GO语言/运用/关于gorm参数问题","date":"2024-10-12T02:28:08.867Z","updated":"2024-10-19T08:25:24.493Z","comments":true,"path":"api/articles/GO语言/运用/关于gorm参数问题.json","keywords":null,"cover":"/images/cover/5.png","text":"关于 gorm 参数问题 var user *models.User var user *models.User = &models.User{} var us...","permalink":"/post/GO语言/运用/关于gorm参数问题","photos":[],"count_time":{"symbolsCount":281,"symbolsTime":"1 mins."},"categories":[{"name":"GO语言","slug":"GO语言","count":77,"path":"api/categories/GO语言.json"}],"tags":[{"name":"技术","slug":"技术","count":168,"path":"api/tags/技术.json"}],"author":{"name":"upstreamboat","slug":"blog-author","avatar":"images/favicon/favicon.ico","link":"/","description":"nothing to say","socials":{"github":"https://github.com/upstreamboat","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{"bilibili":{"icon":"/images/favicon/bilibili.svg","link":"https://www.bilibili.com/"},"chatgpt":{"icon":"/images/favicon/chatgpt.svg","link":"https://chatgpt.com/"}}}}}}